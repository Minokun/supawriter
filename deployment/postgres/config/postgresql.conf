# PostgreSQL 15 配置文件 - 针对4核4GB优化
# 适用于AI写作平台场景

# =============================================================================
# 内存配置 (4GB总内存)
# =============================================================================
shared_buffers = 1GB                    # 25% of RAM，核心缓存
effective_cache_size = 3GB              # 75% of RAM，查询优化器估算
work_mem = 64MB                         # 单个查询工作内存
maintenance_work_mem = 256MB            # 维护操作内存
temp_buffers = 32MB                     # 临时表缓存

# =============================================================================
# 连接配置
# =============================================================================
max_connections = 200                   # 最大连接数
shared_preload_libraries = 'pg_stat_statements'  # 性能统计

# =============================================================================
# 查询优化 (SSD优化)
# =============================================================================
random_page_cost = 1.1                 # SSD随机访问成本
effective_io_concurrency = 200         # SSD并发I/O能力
seq_page_cost = 1.0                     # 顺序访问成本

# =============================================================================
# WAL (Write-Ahead Logging) 配置
# =============================================================================
wal_buffers = 16MB                      # WAL缓冲区
checkpoint_completion_target = 0.9      # 检查点完成目标
max_wal_size = 2GB                      # WAL最大大小
min_wal_size = 512MB                    # WAL最小大小
wal_compression = on                    # WAL压缩

# =============================================================================
# 并行查询配置
# =============================================================================
max_worker_processes = 4                # 最大工作进程数 (CPU核数)
max_parallel_workers = 4                # 最大并行工作进程
max_parallel_workers_per_gather = 2     # 每个Gather节点的并行工作进程
max_parallel_maintenance_workers = 2    # 维护操作并行工作进程

# =============================================================================
# 自动清理配置
# =============================================================================
autovacuum = on                         # 启用自动清理
autovacuum_max_workers = 2              # 自动清理最大工作进程
autovacuum_naptime = 30s                # 自动清理间隔
autovacuum_vacuum_threshold = 50        # 清理阈值
autovacuum_analyze_threshold = 50       # 分析阈值

# =============================================================================
# 日志配置
# =============================================================================
logging_collector = on                  # 启用日志收集
log_directory = 'log'                   # 日志目录
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # 日志文件名
log_min_duration_statement = 1000       # 记录执行时间>1秒的查询
log_checkpoints = on                    # 记录检查点
log_connections = on                    # 记录连接
log_disconnections = on                 # 记录断开连接
log_lock_waits = on                     # 记录锁等待
log_statement = 'ddl'                   # 记录DDL语句

# =============================================================================
# 全文搜索配置 (中文支持)
# =============================================================================
default_text_search_config = 'pg_catalog.simple'  # 简单配置，支持中文

# =============================================================================
# 统计信息配置
# =============================================================================
track_activities = on                   # 跟踪活动
track_counts = on                       # 跟踪计数
track_io_timing = on                    # 跟踪I/O时间
track_functions = all                   # 跟踪函数调用

# =============================================================================
# 其他优化
# =============================================================================
synchronous_commit = on                 # 同步提交 (数据安全)
fsync = on                             # 强制同步 (数据安全)
full_page_writes = on                  # 完整页写入 (数据安全)

# 时区设置
timezone = 'Asia/Shanghai'
log_timezone = 'Asia/Shanghai'

# 网络配置 - 允许公网访问
listen_addresses = '*'                  # 监听所有IP地址
port = 5432                            # 端口号

# 字符集
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'
